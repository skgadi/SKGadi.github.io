<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Add from BibTeX</title>

<link rel="stylesheet" href="css/font-cm.css">
<link rel="stylesheet" href="css/font-uc.css">
<link rel="stylesheet" href="css/web-style.css">

<script   src="https://code.jquery.com/jquery-2.2.4.min.js"   integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="   crossorigin="anonymous"></script>
<script type="text/javascript">
var dbFileName = "SKGadiReferenceManager";
var CLIENT_ID = '283101023526-4o4jti8tl8cusebbogg2qlhpva45uon1.apps.googleusercontent.com';
var SCOPES = ["https://www.googleapis.com/auth/spreadsheets",
	"https://www.googleapis.com/auth/drive",
	"https://www.googleapis.com/auth/drive.appdata",
	"https://www.googleapis.com/auth/drive.file",
	"https://www.googleapis.com/auth/drive.metadata",
	//"https://www.googleapis.com/auth/drive.metadata.readonly",
	//"https://www.googleapis.com/auth/drive.photos.readonly",
	//"https://www.googleapis.com/auth/drive.readonly"
];
var bibstring = "";
function checkAuth() {
	gapi.auth.authorize({
		'client_id' : CLIENT_ID,
		'scope' : SCOPES.join(' '),
		'immediate' : true
	}, handleAuthResult);
}

function handleAuthResult(authResult) {
	var authorizeDiv = document.getElementById('authorize-div');
	if (authResult && !authResult.error) {
		authorizeDiv.style.display = 'none';
		$(".Authrozed ").css('display','inline');
		$('#BibTeXCode').focus();
		loadSheetsApi();
	} else {
		authorizeDiv.style.display = 'inline';
		$(".Authrozed ").css('display','none');
	}
}

function handleAuthClick(event) {
	gapi.auth.authorize({
		client_id : CLIENT_ID,
		scope : SCOPES,
		immediate : false
	},
		handleAuthResult);
	return false;
}

function loadSheetsApi() {
	var discoveryUrl =
		'https://sheets.googleapis.com/$discovery/rest?version=v4';
	gapi.client.load(discoveryUrl).then(function () {
		gapi.client.load('drive', 'v3', listFiles);
	});
}

function listFiles() {
	var request = gapi.client.drive.files.list({
			'q' : 'name=\''+dbFileName+'\'',
			'pageSize' : 10,
			'fields' : "nextPageToken, files(id, name)"
		});

	request.execute(function (resp) {
		var files = resp.files;
		if (files && files.length > 0) {
			/*for (var i = 0; i < files.length; i++) {
			var file = files[i];
			appendPre(file.name + ' (' + file.id + ')');
			}*/
			//GetBibTexString(files[0].id);
		} else {
			//appendPre('No files found.');
			$.notify("No database file is found. Please wait while we create one for you.", "error");
			SpreadsheetCreate()
		}
	});
}

function SpreadsheetCreate(AddItem) {
	/*var URI = "https://www.googleapis.com/drive/v3/files?corpus=user&q=name%3D%22temp%22&key="+CLIENT_ID;
	$.post(URI, function (data) {

	alert(JSON.stringify(data, null, 4));
	});*/
	gapi.client.sheets.spreadsheets.create({
		"properties" : {
			"title" : dbFileName
		},
		sheets : [{
				"properties" : {
					"sheetId" : 0,
					"title" : "db"
				},
				"data" : [{
						"startRow" : 0,
						"startColumn" : 0,
						"rowData" : [{
								"values" : [{
										"userEnteredValue" : {
											"stringValue" : "bibtex"
										}
									}
								]
							}
						]
					}
				]
			}
		]
	}).then(function (response) {
		$.notify("File created.", "success");
		if (AddItem)
			AddToSheet();
		//listFiles();
		//console.log(JSON.parse(response.body).sheets[0].properties.title);
		//console.log(JSON.parse(response));

	});
}

/*$(document).ready(function () {
	//loadSheetsApi();
});
*/
function onSignIn(user) {
	var profile = user.getBasicProfile();
	$('#profile .name').text(profile.getName());
	$('#profile .email').text(profile.getEmail());
}

function AddToSheet (event) {
	//console.log($("#BibTeXCode").val());
	if ($("#BibTeXCode").val()=='')
		$.notify("BibTeX can not be empty", "alert");
	else {
		var request = gapi.client.drive.files.list({
				'q' : 'name=\''+dbFileName+'\'',
				'pageSize' : 10,
				'fields' : "nextPageToken, files(id, name)"
			});

		request.execute(function (resp) {
			var files = resp.files;
			if (files && files.length > 0) {
				gapi.client.sheets.spreadsheets.values.append({
					"spreadsheetId": files[0].id,
					"range": "db!A1",
					"valueInputOption": "USER_ENTERED",
					"insertDataOption": "INSERT_ROWS",
					"values": [[$("#BibTeXCode").val()]]
				}).then(function (response) {
					$.notify("The BibTeX is successfully added to your library.", "success");
					$("#BibTeXCode").val('');
					setTimeout(function() {
						$('#BibTeXCode').focus();
					}, 0);
				});
			} else {
				$.notify("No database file is found. Please wait while we create one for you.", "error");
				SpreadsheetCreate(true);
			}
		});
	}
}
</script>
<script src="https://apis.google.com/js/client.js?onload=checkAuth"> </script>

</head>
<body style="width: 100%; height: 100%; padding: 0px; margin: 0px; font-family: 'cmu_serif'; overflow: scroll;" >
<center><h1>BibTeX</h1><br/><span class="Authrozed" onclick="handleAuthClick(event)" >Paste the BibTeX code here.</span></center>
<div style="text-align: center">
<textarea rows="20" style="width: 95%; background-color: #FFFFF0; border: 5px solid #4e95f4; padding: 5px; font-family: 'Courier'" class="Authrozed" id="BibTeXCode" ></textarea>
<br/>
<button id="authorize-div" onclick="handleAuthClick(event)" class="Button" >Authorize</button> <button onclick="AddToSheet()" class="Authrozed Button">Add BibTeX to eLibrary</button>
</div>

<script type="text/javascript" src="libs/notify.min.js"></script>

</body>
</html>